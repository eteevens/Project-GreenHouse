<!DOCTYPE html> <!-- names the type of document, in this case, HTML5 -->
<html>

<head>

<link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.css" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script><!--The chart.js library-->

<style>

p {
  font-family: verdana;
}

h1 {
  font-family: verdana;
}

img {
  margin: 0;
}

iframe {
  border: 0;
}

.graphics {
  grid-area: graph;
}

.video {
  grid-area: camera;
}

.time-controls {
  grid-area: timing;
}

.other-controls {
  grid-area: controls;
  padding-top: 0%;
}

.layout-container {
  display: grid;
  grid-template-areas:
  'graph graph graph graph camera camera camera'
  'graph graph graph graph camera camera camera'
  'graph graph graph graph camera camera camera'
  'graph graph graph graph timing timing timing'
  'graph graph graph graph timing timing timing'
  'controls controls controls controls timing timing timing';
  grid-template-columns: 12% 12% 12% 12% 12% 12% 12%;
  grid-template-rows: 12% 12% 12% 12% 12% 12%;
  grid-gap: 2%;
  justify-content: center;
}

.layout-container > div {
  text-align: center;
  outline: 1px outset black;
  font-family: verdana;
}

</style>

</head>

<body>

  <!--header and grid layout of the project-->
  <h1 style="text-align:center;"> Project GreenHouse </h1>

  <div class=layout-container>
    <div class=graphics><div>
      <canvas id="live_graph"></canvas>
    </div></div>
    <div class=video><img src="{{ url_for('video_feed_route') }}" height=100%></img>
    </div>
    <div class=time-controls><iframe src="/calendar_feed"></iframe></div>
    <div class=other-controls width=100%>
        <form id="form_data">
          <label for="temp">Temperature:</label>
          <input type="number" id="temp" name="temp" min="10"><br>
          <label for="water_drip">Water Drip:</label>
          <input type="checkbox" id="water_drip" name="water_drip">
          <label for="lights">Lights:</label>
          <input type="checkbox" id="lights" name="lights">
          <br>
          <input type="submit" value="Submit">
        </form>
    </div>
  </div>

  <!--suppress JSUnresolvedLibraryURL -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
  <!--suppress JSUnresolvedLibraryURL -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min.js"></script>
  <!--suppress JSUnresolvedLibraryURL -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.js"></script>
  <script>

    function generateColor() {
      var hsl = 'hsla(' + Math.floor(Math.random() * 360) + ', 100%, 50%, 1)';
      return hsl;
    }

    /**
 * Fixes the issue with checkbox forms using serializeArray which ordinarily
 * only respond when toggled on.
 *
 * @see https://ourcodeworld.com/articles/read/1030/how-to-change-the-on-and-off-values-to-boolean-true-or-false-from-checkboxes-with-serialization-with-jquery-serialize-and-serializearray
 */
(function ($) {
    $.fn.serialize = function (options) {
        return $.param(this.serializeArray(options));
    };

    $.fn.serializeArray = function (options) {
        var o = $.extend({
            checkboxesAsBools: false
        }, options || {});

        var rselectTextarea = /select|textarea/i;
        var rinput = /text|hidden|password|search|number/i;

        return this.map(function () {
            return this.elements ? $.makeArray(this.elements) : this;
        })
        .filter(function () {
            return this.name && !this.disabled &&
                (this.checked
                || (o.checkboxesAsBools && this.type === 'checkbox')
                || rselectTextarea.test(this.nodeName)
                || rinput.test(this.type));
            })
            .map(function (i, elem) {
                var val = $(this).val();
                return val == null ?
                null :
                $.isArray(val) ?
                $.map(val, function (val, i) {
                    return { name: elem.name, value: val };
                }) :
                {
                    name: elem.name,
                    value: (o.checkboxesAsBools && this.type === 'checkbox') ?
                        (this.checked ? "true" : "false") :
                        val
                };
            }).get();
    };
})(jQuery);


    $("#form_data").submit(function (event) {

       var outputCount = 3; //the number of output controls

       var userInput = [];
       var outputData = {};

       for (iterRead = 0; iterRead < outputCount; iterRead++) {
         userInput.push($("#form_data").serializeArray(
           {checkboxesAsBools: true})[iterRead]);
         outputData[userInput[iterRead]["name"]] = userInput[iterRead]["value"];

         if (outputData[userInput[iterRead]["name"]] == "") {
           alert('Error, no data inputed');
           event.preventDefault();
         }
       }

     $.ajax({type:"POST",
              url:"/controls_feed",
              data:JSON.stringify(outputData),
              contentType: "application/json",})

              .fail(function( ) {
                 console.log("Error with the html posting of control_feed");
               });


         event.preventDefault();
    });


    $(document).ready(function () {

    var inputCount = 3; //the number of different incoming data
    //for the graph

    const dataDisplay = [];

    for (iterDisplay = 0; iterDisplay < inputCount; iterDisplay++) {
       dataDisplay.push({data: [], fill: false, label: ''});
    }

    const dataInfo = {
      datasets: dataDisplay.map(v => {
        var color = generateColor();
        return {...v, backgroundColor: color, borderColor: color}
      })
    };

    const config = {
      type: 'line',
      labels: [],
      data: dataInfo,
      options: {
        responsive: true,
        scales: {
          y: {beginAtZero: true},
          yAxes: [{ticks: {max: 100}}],
        },
        animation: false
      }
    };

      const context = document.getElementById('live_graph').getContext('2d');

      const live_graph = new Chart(context, config);

      const source = new EventSource("/graph_feed");

      source.onmessage = function (event) {
        const data = JSON.parse(event.data);
        if (config.data.labels.length === 10) {
          config.data.labels.shift();
          for (iterShift = 0; iterShift < inputCount; iterShift++) {
            config.data.datasets[iterShift].data.shift();
          }
        }
        config.data.labels.push(data.time);

        var iterUpdate = 0;

        for (let value in data) {
          if (value != 'time') {
            config.data.datasets[iterUpdate].data.push(data[value]);
            if (config.data.datasets[iterUpdate].label != String(value)) {
              config.data.datasets[iterUpdate].label = String(value);
            }
            iterUpdate++;
          }
        }

        live_graph.update();
      };
    });

  </script>

</body>

</html>
